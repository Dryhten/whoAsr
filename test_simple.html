<!DOCTYPE html>
<html>
<head>
    <title>Simple Speech Recognition Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            box-sizing: border-box;
        }
        .status { 
            margin: 10px 0; 
            padding: 10px; 
            background: #f0f0f0; 
            border-radius: 5px;
        }
        .controls {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button { 
            padding: 10px 20px; 
            margin: 0; 
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        #startBtn { background: #28a745; color: white; }
        #stopBtn { background: #dc3545; color: white; }
        #reconnectBtn { background: #007bff; color: white; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .results { 
            margin: 10px 0; 
            padding: 10px; 
            background: #f9f9f9; 
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .result-item {
            padding: 5px 10px;
            margin: 2px 0;
            border-left: 3px solid #007bff;
            background: white;
            border-radius: 3px;
            font-size: 14px;
            line-height: 1.4;
        }
        .result-item.final {
            border-left-color: #28a745;
            font-weight: bold;
        }
        h1, h3 {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Simple Speech Recognition Test</h1>
    
    <div class="status" id="status">Status: Connecting...</div>
    
    <div class="controls">
        <button id="startBtn" onclick="startRecording()" disabled>Start Recording</button>
        <button id="stopBtn" onclick="stopRecording()" disabled>Stop Recording</button>
        <button id="reconnectBtn" onclick="reconnectWebSocket()">Reconnect</button>
    </div>
    
    <div class="results">
        <h3>Results:</h3>
        <div id="resultsList"></div>
    </div>

    <script>
        let ws = null;
        let mediaRecorder = null;
        let isRecording = false;
        let audioContext = null;

        function updateStatus(message) {
            document.getElementById('status').textContent = 'Status: ' + message;
        }

        function updateDebug(message) {
            // Only output to console, not to the UI
            console.log(new Date().toLocaleTimeString() + ': ' + message);
        }

        function addResult(text, isFinal) {
            const resultsList = document.getElementById('resultsList');
            
            // If it's a final result, update the last non-final result if exists
            if (isFinal) {
                const lastResult = resultsList.lastElementChild;
                if (lastResult && !lastResult.classList.contains('final')) {
                    lastResult.textContent += text;
                    lastResult.classList.add('final');
                    return;
                }
            }
            
            // Check if there's a non-final result to append to
            const lastResult = resultsList.lastElementChild;
            if (lastResult && !lastResult.classList.contains('final')) {
                // Append to existing result
                lastResult.textContent += text;
            } else {
                // Create new result item
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item' + (isFinal ? ' final' : '');
                resultItem.textContent = text;
                resultsList.appendChild(resultItem);
            }
            
            // Auto scroll to bottom
            resultsList.scrollTop = resultsList.scrollHeight;
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${Date.now()}`;
            
            updateDebug('Connecting to: ' + wsUrl);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                updateStatus('Connected');
                updateDebug('WebSocket connected');
                document.getElementById('startBtn').disabled = false;
                document.getElementById('reconnectBtn').disabled = true;
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateDebug('Received: ' + JSON.stringify(data));
                
                if (data.type === 'recognition_result') {
                    addResult(data.text, data.is_final);
                } else if (data.type === 'error') {
                    updateStatus('Error: ' + data.message);
                    updateDebug('Error: ' + data.message);
                } else if (data.type === 'status') {
                    updateStatus(data.message);
                    updateDebug('Status: ' + data.message);
                }
            };
            
            ws.onclose = function() {
                updateStatus('Disconnected');
                updateDebug('WebSocket disconnected');
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('reconnectBtn').disabled = false;
            };
            
            ws.onerror = function(error) {
                updateStatus('Connection error');
                updateDebug('WebSocket error: ' + error);
                document.getElementById('reconnectBtn').disabled = false;
            };
        }

        function reconnectWebSocket() {
            // Close existing connection if any
            if (ws) {
                ws.close();
                ws = null;
            }
            
            // Clear results
            document.getElementById('resultsList').innerHTML = '';
            
            // Reconnect
            document.getElementById('reconnectBtn').disabled = true;
            updateStatus('Reconnecting...');
            connectWebSocket();
        }

        async function startRecording() {
            try {
                updateDebug('Requesting microphone access...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Initialize audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                updateDebug('Audio context sample rate: ' + audioContext.sampleRate);
                
                // Use Web Audio API for direct audio capture
                const source = audioContext.createMediaStreamSource(stream);
                const processor = audioContext.createScriptProcessor(4096, 1, 1);
                
                processor.onaudioprocess = function(e) {
                    if (isRecording && ws && ws.readyState === WebSocket.OPEN) {
                        const inputBuffer = e.inputBuffer;
                        const inputData = inputBuffer.getChannelData(0);
                        
                        updateDebug('Audio chunk received, length: ' + inputData.length);
                        
                        // Resample to 16kHz if needed
                        const targetSampleRate = 16000;
                        let audioData = inputData;
                        
                        if (audioContext.sampleRate !== targetSampleRate) {
                            const ratio = audioContext.sampleRate / targetSampleRate;
                            const newLength = Math.floor(inputData.length / ratio);
                            audioData = new Float32Array(newLength);
                            
                            for (let i = 0; i < newLength; i++) {
                                const srcIndex = Math.floor(i * ratio);
                                audioData[i] = inputData[srcIndex];
                            }
                            
                            updateDebug('Resampled audio to 16kHz, new length: ' + audioData.length);
                        }
                        
                        // Convert to base64
                        const base64Audio = btoa(String.fromCharCode(...new Uint8Array(audioData.buffer)));
                        updateDebug('Base64 audio length: ' + base64Audio.length);
                        
                        ws.send(JSON.stringify({
                            type: 'audio_chunk',
                            data: base64Audio
                        }));
                        
                        updateDebug('Audio chunk sent');
                    }
                };
                
                source.connect(processor);
                processor.connect(audioContext.destination);
                
                isRecording = true;
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                updateStatus('Recording...');
                updateDebug('Recording started');
                
                // Send start message
                ws.send(JSON.stringify({ type: 'start_recording' }));
                
                // Store references for cleanup
                mediaRecorder = { stream: stream, source: source, processor: processor };
                
            } catch (error) {
                updateDebug('Error accessing microphone: ' + error.message);
                updateStatus('Microphone access denied');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                // Stop the audio processing
                if (mediaRecorder.processor) {
                    mediaRecorder.processor.disconnect();
                }
                if (mediaRecorder.source) {
                    mediaRecorder.source.disconnect();
                }
                
                // Stop the media stream
                if (mediaRecorder.stream) {
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
                
                isRecording = false;
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                updateStatus('Processing final audio...');
                updateDebug('Recording stopped');
                
                // Send stop message
                ws.send(JSON.stringify({ type: 'stop_recording' }));
            }
        }

        // Connect WebSocket on page load
        window.onload = function() {
            connectWebSocket();
        };
    </script>
</body>
</html>
